---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: traefik
  namespace: traefik
spec:
  releaseName: traefik
  chart:
    spec:
      chart: traefik
      version: 9.11.0
      sourceRef:
        kind: HelmRepository
        name: traefik
        namespace: traefik
  interval: 1m0s
  values:
    ports:
      metrics:
        port: 8082
        expose: true
        exposedPort: 8082
        protocol: TCP
    additionalArguments:
      - --metrics.prometheus=true
      - --metrics.prometheus.entryPoint=metrics
      - --entryPoints.metrics.address=:8082
    deployment:
      replicas: 3
      podAnnotations:
        linkerd.io/inject: ingress
        config.linkerd.io/skip-outbound-ports: 8443
        config.linkerd.io/opaque-ports: 8443,8000
    logs:
      access:
        enabled: true
        format: json
        fields:
          headers:
            defaultmode: drop
            names:
              X-Real-Ip: keep
    service:
      spec:
        externalTrafficPolicy: Local
        loadBalancerIP: 192.168.2.0
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                  app.kubernetes.io/instance: traefik
            topologyKey: kubernetes.io/hostname
        # preferredDuringSchedulingIgnoredDuringExecution:
        #   - weight: 100
        #     podAffinityTerm:
        #       topologyKey: kubernetes.io/hostname
        #       labelSelector:
        #         matchLabels:
        #           app.kubernetes.io/instance: traefik
